---
phase: 01-core-display
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - lib/view/bluetoothaudio/bluetooth_audio_page.dart
  - lib/main.dart
  - lib/l10n/app_en.arb
  - lib/l10n/app_zh.arb
autonomous: true

must_haves:
  truths:
    - "用戶可以從左側選單進入藍牙音訊頁面"
    - "頁面正確顯示裝置名稱、MAC 位址"
    - "頁面正確顯示 codec 類型、取樣率、位元深度、聲道模式"
    - "無裝置連接時顯示空狀態提示"
    - "權限被拒絕時顯示請求權限按鈕"
    - "Android 8.0 以下顯示不支援訊息"
  artifacts:
    - path: "lib/view/bluetoothaudio/bluetooth_audio_page.dart"
      provides: "藍牙音訊頁面 UI"
      min_lines: 150
    - path: "lib/main.dart"
      provides: "導航整合"
      contains: "BluetoothAudioPage"
  key_links:
    - from: "lib/main.dart"
      to: "lib/view/bluetoothaudio/bluetooth_audio_page.dart"
      via: "import and navigation"
      pattern: "BluetoothAudioPage"
    - from: "bluetooth_audio_page.dart"
      to: "bluetooth_audio_cubit.dart"
      via: "BlocBuilder"
      pattern: "BlocBuilder.*BluetoothAudioState"
---

<objective>
建立藍牙音訊頁面 UI 並整合到左側選單導航

Purpose: 讓用戶可以從選單進入頁面，查看藍牙音訊裝置資訊
Output: 完整的 BluetoothAudioPage UI，已整合到 main.dart 導航
</objective>

<execution_context>
@/Users/tonynowater/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonynowater/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-display/01-RESEARCH.md

# 參考現有頁面模式
@lib/view/androiddeviceinfo/android_device_info_page.dart
@lib/main.dart

# 依賴前置計畫的產出
# Plan 01-01 產出: BluetoothAudioHandler (Android 端)
# Plan 01-02 產出: BluetoothAudioCubit, BluetoothAudioState, BluetoothAudioModel
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 BluetoothAudioPage UI</name>
  <files>lib/view/bluetoothaudio/bluetooth_audio_page.dart</files>
  <action>
建立藍牙音訊頁面，遵循專案現有的頁面模式（參考 android_device_info_page.dart）：

```dart
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:device_info_tool/l10n/app_localizations.dart';
import 'package:device_info_tool/view/bluetoothaudio/bluetooth_audio_cubit.dart';
import 'package:device_info_tool/data/model/bluetooth_audio_model.dart';

class BluetoothAudioPage extends StatefulWidget {
  const BluetoothAudioPage({Key? key}) : super(key: key);

  @override
  State<BluetoothAudioPage> createState() => _BluetoothAudioPageState();
}

class _BluetoothAudioPageState extends State<BluetoothAudioPage> {
  @override
  void initState() {
    super.initState();
    context.read<BluetoothAudioCubit>().load();
  }

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<BluetoothAudioCubit, BluetoothAudioState>(
      builder: (context, state) {
        return _buildContent(context, state);
      },
    );
  }

  Widget _buildContent(BuildContext context, BluetoothAudioState state) {
    if (state is BluetoothAudioLoading || state is BluetoothAudioInitial) {
      return const Center(child: CircularProgressIndicator());
    }

    if (state is BluetoothAudioNotSupported) {
      return _buildNotSupportedView(context, state.reason);
    }

    if (state is BluetoothAudioPermissionDenied) {
      return _buildPermissionDeniedView(context, state.isPermanentlyDenied);
    }

    if (state is BluetoothAudioPermissionRequired) {
      return _buildPermissionRequiredView(context);
    }

    if (state is BluetoothAudioBluetoothDisabled) {
      return _buildBluetoothDisabledView(context);
    }

    if (state is BluetoothAudioNoDevice) {
      return _buildNoDeviceView(context);
    }

    if (state is BluetoothAudioError) {
      return _buildErrorView(context, state.message);
    }

    if (state is BluetoothAudioLoaded) {
      return _buildLoadedView(context, state.audioInfo);
    }

    return const SizedBox.shrink();
  }

  Widget _buildNotSupportedView(BuildContext context, String reason) {
    final l10n = AppLocalizations.of(context);
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.error_outline, size: 64, color: Colors.orange),
            const SizedBox(height: 16),
            Text(
              l10n.bluetoothNotSupported,
              style: Theme.of(context).textTheme.titleLarge,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(reason, textAlign: TextAlign.center),
          ],
        ),
      ),
    );
  }

  Widget _buildPermissionDeniedView(BuildContext context, bool isPermanentlyDenied) {
    final l10n = AppLocalizations.of(context);
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.bluetooth_disabled, size: 64, color: Colors.grey),
            const SizedBox(height: 16),
            Text(
              l10n.bluetoothPermissionRequired,
              style: Theme.of(context).textTheme.titleLarge,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(
              isPermanentlyDenied
                  ? l10n.bluetoothPermissionPermanentlyDenied
                  : l10n.bluetoothPermissionDenied,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: () {
                if (isPermanentlyDenied) {
                  context.read<BluetoothAudioCubit>().openSettings();
                } else {
                  context.read<BluetoothAudioCubit>().retry();
                }
              },
              child: Text(isPermanentlyDenied ? l10n.openSettings : l10n.retry),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPermissionRequiredView(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.bluetooth, size: 64, color: Colors.blue),
            const SizedBox(height: 16),
            Text(
              l10n.bluetoothPermissionRequired,
              style: Theme.of(context).textTheme.titleLarge,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: () => context.read<BluetoothAudioCubit>().retry(),
              child: Text(l10n.requestPermission),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildBluetoothDisabledView(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.bluetooth_disabled, size: 64, color: Colors.grey),
            const SizedBox(height: 16),
            Text(
              l10n.bluetoothDisabled,
              style: Theme.of(context).textTheme.titleLarge,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(l10n.bluetoothDisabledHint, textAlign: TextAlign.center),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: () => context.read<BluetoothAudioCubit>().retry(),
              child: Text(l10n.retry),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildNoDeviceView(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.headphones_outlined, size: 64, color: Colors.grey),
            const SizedBox(height: 16),
            Text(
              l10n.noBluetoothDevice,
              style: Theme.of(context).textTheme.titleLarge,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(l10n.noBluetoothDeviceHint, textAlign: TextAlign.center),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: () => context.read<BluetoothAudioCubit>().retry(),
              child: Text(l10n.retry),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildErrorView(BuildContext context, String message) {
    final l10n = AppLocalizations.of(context);
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.error_outline, size: 64, color: Colors.red),
            const SizedBox(height: 16),
            Text(
              l10n.error,
              style: Theme.of(context).textTheme.titleLarge,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(message, textAlign: TextAlign.center),
            const SizedBox(height: 24),
            ElevatedButton(
              onPressed: () => context.read<BluetoothAudioCubit>().retry(),
              child: Text(l10n.retry),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLoadedView(BuildContext context, BluetoothAudioInfo audioInfo) {
    final l10n = AppLocalizations.of(context);
    return RefreshIndicator(
      onRefresh: () => context.read<BluetoothAudioCubit>().retry(),
      child: ListView(
        padding: const EdgeInsets.all(16.0),
        children: [
          // 裝置資訊區塊
          _buildSectionHeader(context, l10n.deviceInfo, Icons.headphones),
          _buildInfoCard(context, [
            _buildInfoRow(l10n.deviceName, audioInfo.deviceInfo.deviceName),
            _buildInfoRow(l10n.macAddress, audioInfo.deviceInfo.deviceAddress),
            _buildInfoRow(l10n.batteryLevel, audioInfo.deviceInfo.formattedBatteryLevel),
          ]),
          const SizedBox(height: 16),
          // Codec 資訊區塊
          _buildSectionHeader(context, l10n.codecInfo, Icons.audiotrack),
          _buildInfoCard(context, [
            _buildInfoRow(l10n.codecType, audioInfo.codecInfo.codecType),
            _buildInfoRow(l10n.sampleRate, audioInfo.codecInfo.sampleRate),
            _buildInfoRow(l10n.bitsPerSample, audioInfo.codecInfo.bitsPerSample),
            _buildInfoRow(l10n.channelMode, audioInfo.codecInfo.channelMode),
          ]),
        ],
      ),
    );
  }

  Widget _buildSectionHeader(BuildContext context, String title, IconData icon) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Row(
        children: [
          Icon(icon, size: 20, color: Theme.of(context).colorScheme.primary),
          const SizedBox(width: 8),
          Text(
            title,
            style: Theme.of(context).textTheme.titleMedium?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoCard(BuildContext context, List<Widget> children) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(children: children),
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Expanded(
            flex: 2,
            child: Text(label, style: const TextStyle(color: Colors.grey)),
          ),
          Expanded(
            flex: 3,
            child: Text(
              value,
              textAlign: TextAlign.end,
              style: const TextStyle(fontWeight: FontWeight.w500),
            ),
          ),
        ],
      ),
    );
  }
}
```
  </action>
  <verify>
```bash
flutter analyze lib/view/bluetoothaudio/bluetooth_audio_page.dart 2>&1 | tail -5
```
預期無錯誤（可能有 l10n key 未定義的警告，將在 Task 2 解決）
  </verify>
  <done>bluetooth_audio_page.dart 存在，包含所有狀態的 UI 處理（載入中、權限、錯誤、空狀態、成功顯示）</done>
</task>

<task type="auto">
  <name>Task 2: 新增本地化字串</name>
  <files>
lib/l10n/app_en.arb
lib/l10n/app_zh.arb
  </files>
  <action>
在 app_en.arb 新增英文字串：

```json
"bluetoothAudio": "Bluetooth Audio",
"bluetoothNotSupported": "Not Supported",
"bluetoothPermissionRequired": "Bluetooth Permission Required",
"bluetoothPermissionDenied": "Please grant Bluetooth permission to view device information.",
"bluetoothPermissionPermanentlyDenied": "Bluetooth permission was denied. Please enable it in Settings.",
"bluetoothDisabled": "Bluetooth is Disabled",
"bluetoothDisabledHint": "Please enable Bluetooth to view connected device information.",
"noBluetoothDevice": "No Bluetooth Audio Device",
"noBluetoothDeviceHint": "Please connect a Bluetooth headphone or speaker to view its information.",
"requestPermission": "Request Permission",
"openSettings": "Open Settings",
"retry": "Retry",
"error": "Error",
"deviceName": "Device Name",
"macAddress": "MAC Address",
"batteryLevel": "Battery Level",
"codecInfo": "Codec Information",
"codecType": "Codec Type",
"sampleRate": "Sample Rate",
"bitsPerSample": "Bits Per Sample",
"channelMode": "Channel Mode"
```

在 app_zh.arb 新增繁體中文字串：

```json
"bluetoothAudio": "藍牙音訊",
"bluetoothNotSupported": "不支援",
"bluetoothPermissionRequired": "需要藍牙權限",
"bluetoothPermissionDenied": "請授予藍牙權限以查看裝置資訊。",
"bluetoothPermissionPermanentlyDenied": "藍牙權限已被拒絕。請前往設定開啟權限。",
"bluetoothDisabled": "藍牙已關閉",
"bluetoothDisabledHint": "請開啟藍牙以查看已連接裝置資訊。",
"noBluetoothDevice": "無藍牙音訊裝置",
"noBluetoothDeviceHint": "請連接藍牙耳機或喇叭以查看裝置資訊。",
"requestPermission": "請求權限",
"openSettings": "開啟設定",
"retry": "重試",
"error": "錯誤",
"deviceName": "裝置名稱",
"macAddress": "MAC 位址",
"batteryLevel": "電量",
"codecInfo": "編碼資訊",
"codecType": "Codec 類型",
"sampleRate": "取樣率",
"bitsPerSample": "位元深度",
"channelMode": "聲道模式"
```

注意：將這些 key-value 對加入到現有的 JSON 物件中（在最後一個 key 前加上逗號），不要覆蓋現有內容。
  </action>
  <verify>
```bash
flutter gen-l10n 2>&1 | tail -5
```
預期無錯誤
  </verify>
  <done>app_en.arb 和 app_zh.arb 包含所有需要的本地化字串</done>
</task>

<task type="auto">
  <name>Task 3: 整合藍牙音訊頁面到 main.dart 導航</name>
  <files>lib/main.dart</files>
  <action>
修改 main.dart 以新增藍牙音訊頁面到左側選單：

1. 新增 import：
```dart
import 'package:device_info_tool/view/bluetoothaudio/bluetooth_audio_page.dart';
import 'package:device_info_tool/view/bluetoothaudio/bluetooth_audio_cubit.dart';
```

2. 在 Android 平台的 pageNames 列表中，在 "Device Info" 後面新增：
```dart
l10n.bluetoothAudio,
```

3. 在 bottomNavBarItems 的 Android 區塊中，在 Device Info DrawerTile 後面新增：
```dart
DrawerTile(
    selected: currentPageIndex == 1,  // 注意：需要調整其他項目的 index
    icon: const Icon(Icons.headphones),
    title: pageNames[1],  // 這裡的 index 需要對應 pageNames 中的位置
    onTap: (title) {
      changePageByIndex(1, title);
    }),
```

4. 在 screens 列表的 Android 區塊中新增：
```dart
BlocProvider(
  create: (context) => BluetoothAudioCubit(),
  child: const BluetoothAudioPage(),
),
```

5. **重要**：由於新增了一個頁面，需要將所有後續頁面的 index 都加 1：
   - 原本 index 1 的頁面變成 index 2
   - 原本 index 2 的頁面變成 index 3
   - 以此類推...

這個調整需要修改：
- pageNames 陣列中的順序
- bottomNavBarItems 中每個 DrawerTile 的 selected 判斷和 changePageByIndex 呼叫
- screens 陣列中的順序
- _buildAppBarActions() 中判斷 Intent Actions 頁面的 index（從 1 變成 2）
  </action>
  <verify>
```bash
flutter analyze lib/main.dart 2>&1 | tail -10
```
預期無錯誤
  </verify>
  <done>main.dart 已整合 BluetoothAudioPage，左側選單可導航到藍牙音訊頁面</done>
</task>

</tasks>

<verification>
1. flutter analyze 無錯誤
2. flutter gen-l10n 無錯誤
3. BluetoothAudioPage 可從左側選單進入
4. 所有狀態都有對應的 UI
</verification>

<success_criteria>
- 用戶可從左側選單進入藍牙音訊頁面 (NAV-01)
- 頁面顯示裝置名稱、MAC 位址 (DEVICE-01, DEVICE-02)
- 頁面顯示 codec 類型、取樣率、位元深度、聲道模式 (CODEC-01 ~ CODEC-05)
- 無裝置時顯示空狀態 (PERM-02)
- 權限請求流程正確 (PERM-01)
- Android 8.0 以下顯示不支援 (PERM-03)
</success_criteria>

<output>
完成後建立 `.planning/phases/01-core-display/01-03-SUMMARY.md`
</output>
