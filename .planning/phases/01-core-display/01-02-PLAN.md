---
phase: 01-core-display
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pubspec.yaml
  - lib/data/model/bluetooth_audio_model.dart
  - lib/view/bluetoothaudio/bluetooth_audio_state.dart
  - lib/view/bluetoothaudio/bluetooth_audio_cubit.dart
autonomous: true

must_haves:
  truths:
    - "Flutter 專案包含 permission_handler 依賴"
    - "BluetoothAudioModel 可正確解析原生端返回的 Map 資料"
    - "BluetoothAudioCubit 可管理載入、權限、錯誤等狀態"
  artifacts:
    - path: "lib/data/model/bluetooth_audio_model.dart"
      provides: "藍牙音訊資料模型"
      min_lines: 40
    - path: "lib/view/bluetoothaudio/bluetooth_audio_cubit.dart"
      provides: "狀態管理邏輯"
      min_lines: 80
    - path: "lib/view/bluetoothaudio/bluetooth_audio_state.dart"
      provides: "狀態類別定義"
      min_lines: 30
  key_links:
    - from: "bluetooth_audio_cubit.dart"
      to: "permission_handler"
      via: "import and Permission.bluetoothConnect"
      pattern: "Permission\\.bluetoothConnect"
    - from: "bluetooth_audio_cubit.dart"
      to: "MethodChannel"
      via: "Platform Channel invocation"
      pattern: "invokeMethod.*getBluetoothAudioInfo"
---

<objective>
建立 Flutter 端資料模型與狀態管理，處理藍牙權限請求

Purpose: 提供 Flutter 端的資料結構與狀態管理，為 UI 層提供乾淨的資料介面
Output: BluetoothAudioModel、BluetoothAudioState、BluetoothAudioCubit
</objective>

<execution_context>
@/Users/tonynowater/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonynowater/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-display/01-RESEARCH.md

# 參考現有 Cubit 模式
@lib/view/androiddeviceinfo/android_device_info_cubit.dart
@lib/view/androiddeviceinfo/android_device_info_state.dart
@lib/view/androiddeviceinfo/android_device_info_model.dart
@pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: 新增 permission_handler 依賴</name>
  <files>pubspec.yaml</files>
  <action>
在 pubspec.yaml 的 dependencies 區塊中新增 permission_handler 套件：

```yaml
permission_handler: ^11.0.0
```

放在現有依賴列表中適當位置（按字母順序或功能分組）。

然後執行 flutter pub get 安裝依賴。

注意：此套件需要 Android 專案的額外設定，但權限宣告已在 Plan 01 中處理。
  </action>
  <verify>
```bash
flutter pub get && flutter pub deps | grep permission_handler
```
預期輸出顯示 permission_handler 已安裝
  </verify>
  <done>permission_handler ^11.0.0 已加入 pubspec.yaml 並成功安裝</done>
</task>

<task type="auto">
  <name>Task 2: 建立 BluetoothAudioModel 資料模型</name>
  <files>lib/data/model/bluetooth_audio_model.dart</files>
  <action>
建立資料模型類別：

```dart
/// 藍牙音訊裝置資訊模型
class BluetoothDeviceInfo {
  final String deviceName;
  final String deviceAddress;
  final int? batteryLevel; // -1 表示不支援

  BluetoothDeviceInfo({
    required this.deviceName,
    required this.deviceAddress,
    this.batteryLevel,
  });

  factory BluetoothDeviceInfo.fromMap(Map<String, dynamic> map) {
    return BluetoothDeviceInfo(
      deviceName: map['deviceName'] as String? ?? 'Unknown',
      deviceAddress: map['deviceAddress'] as String? ?? 'Unknown',
      batteryLevel: map['batteryLevel'] as int?,
    );
  }

  String get formattedBatteryLevel {
    if (batteryLevel == null || batteryLevel! < 0) return '不支援';
    return '$batteryLevel%';
  }
}

/// 藍牙 Codec 資訊模型
class BluetoothCodecInfo {
  final String codecType;
  final String sampleRate;
  final String bitsPerSample;
  final String channelMode;

  BluetoothCodecInfo({
    required this.codecType,
    required this.sampleRate,
    required this.bitsPerSample,
    required this.channelMode,
  });

  factory BluetoothCodecInfo.fromMap(Map<String, dynamic> map) {
    return BluetoothCodecInfo(
      codecType: map['codecType'] as String? ?? 'Unknown',
      sampleRate: map['sampleRate'] as String? ?? 'Unknown',
      bitsPerSample: map['bitsPerSample'] as String? ?? 'Unknown',
      channelMode: map['channelMode'] as String? ?? 'Unknown',
    );
  }
}

/// 完整的藍牙音訊資訊模型
class BluetoothAudioInfo {
  final BluetoothDeviceInfo deviceInfo;
  final BluetoothCodecInfo codecInfo;

  BluetoothAudioInfo({
    required this.deviceInfo,
    required this.codecInfo,
  });

  factory BluetoothAudioInfo.fromMap(Map<String, dynamic> map) {
    return BluetoothAudioInfo(
      deviceInfo: BluetoothDeviceInfo.fromMap(map),
      codecInfo: BluetoothCodecInfo.fromMap(map),
    );
  }
}
```
  </action>
  <verify>
```bash
flutter analyze lib/data/model/bluetooth_audio_model.dart 2>&1 | tail -5
```
預期無錯誤
  </verify>
  <done>bluetooth_audio_model.dart 存在，包含 BluetoothDeviceInfo、BluetoothCodecInfo、BluetoothAudioInfo 三個類別，每個都有 fromMap factory constructor</done>
</task>

<task type="auto">
  <name>Task 3: 建立 BluetoothAudioState 與 BluetoothAudioCubit</name>
  <files>
lib/view/bluetoothaudio/bluetooth_audio_state.dart
lib/view/bluetoothaudio/bluetooth_audio_cubit.dart
  </files>
  <action>
建立狀態類別 bluetooth_audio_state.dart：

```dart
part of 'bluetooth_audio_cubit.dart';

/// 藍牙音訊頁面狀態基類
abstract class BluetoothAudioState {}

/// 初始狀態
class BluetoothAudioInitial extends BluetoothAudioState {}

/// 載入中
class BluetoothAudioLoading extends BluetoothAudioState {}

/// 需要權限
class BluetoothAudioPermissionRequired extends BluetoothAudioState {}

/// 權限被拒絕
class BluetoothAudioPermissionDenied extends BluetoothAudioState {
  final bool isPermanentlyDenied;
  BluetoothAudioPermissionDenied({this.isPermanentlyDenied = false});
}

/// 不支援（Android 8.0 以下）
class BluetoothAudioNotSupported extends BluetoothAudioState {
  final String reason;
  BluetoothAudioNotSupported({required this.reason});
}

/// 藍牙未開啟
class BluetoothAudioBluetoothDisabled extends BluetoothAudioState {}

/// 無已連接裝置
class BluetoothAudioNoDevice extends BluetoothAudioState {}

/// 載入成功
class BluetoothAudioLoaded extends BluetoothAudioState {
  final BluetoothAudioInfo audioInfo;
  BluetoothAudioLoaded({required this.audioInfo});
}

/// 載入失敗
class BluetoothAudioError extends BluetoothAudioState {
  final String message;
  BluetoothAudioError({required this.message});
}
```

建立 Cubit bluetooth_audio_cubit.dart：

```dart
import 'dart:io';
import 'package:bloc/bloc.dart';
import 'package:device_info_plus/device_info_plus.dart';
import 'package:flutter/services.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:device_info_tool/data/model/bluetooth_audio_model.dart';

part 'bluetooth_audio_state.dart';

class BluetoothAudioCubit extends Cubit<BluetoothAudioState> {
  static const _channel = MethodChannel('com.tonynowater.mobileosversions');

  BluetoothAudioCubit() : super(BluetoothAudioInitial());

  Future<void> load() async {
    emit(BluetoothAudioLoading());

    // 檢查平台
    if (!Platform.isAndroid) {
      emit(BluetoothAudioNotSupported(reason: '僅支援 Android 平台'));
      return;
    }

    // 檢查 Android 版本
    final androidInfo = await DeviceInfoPlugin().androidInfo;
    if (androidInfo.version.sdkInt < 26) {
      emit(BluetoothAudioNotSupported(reason: 'Android 8.0 以下不支援'));
      return;
    }

    // 檢查並請求權限（Android 12+）
    if (androidInfo.version.sdkInt >= 31) {
      final permissionStatus = await Permission.bluetoothConnect.status;

      if (permissionStatus.isDenied) {
        final result = await Permission.bluetoothConnect.request();
        if (result.isDenied) {
          emit(BluetoothAudioPermissionDenied(isPermanentlyDenied: false));
          return;
        }
        if (result.isPermanentlyDenied) {
          emit(BluetoothAudioPermissionDenied(isPermanentlyDenied: true));
          return;
        }
      }

      if (permissionStatus.isPermanentlyDenied) {
        emit(BluetoothAudioPermissionDenied(isPermanentlyDenied: true));
        return;
      }
    }

    // 呼叫原生端取得資訊
    try {
      final result = await _channel.invokeMethod('getBluetoothAudioInfo');
      final map = Map<String, dynamic>.from(result as Map);

      // 檢查錯誤回應
      if (map.containsKey('error')) {
        final error = map['error'] as String;
        switch (error) {
          case 'unsupported':
            emit(BluetoothAudioNotSupported(reason: map['reason'] as String? ?? '不支援'));
            break;
          case 'bluetooth_disabled':
            emit(BluetoothAudioBluetoothDisabled());
            break;
          case 'no_device':
            emit(BluetoothAudioNoDevice());
            break;
          default:
            emit(BluetoothAudioError(message: error));
        }
        return;
      }

      // 解析成功回應
      final audioInfo = BluetoothAudioInfo.fromMap(map);
      emit(BluetoothAudioLoaded(audioInfo: audioInfo));
    } on PlatformException catch (e) {
      emit(BluetoothAudioError(message: e.message ?? '未知錯誤'));
    } catch (e) {
      emit(BluetoothAudioError(message: e.toString()));
    }
  }

  /// 開啟應用程式設定頁面（用於永久拒絕權限的情況）
  Future<void> openSettings() async {
    await openAppSettings();
  }

  /// 重新嘗試載入
  Future<void> retry() async {
    await load();
  }
}
```
  </action>
  <verify>
```bash
flutter analyze lib/view/bluetoothaudio/ 2>&1 | tail -10
```
預期無錯誤
  </verify>
  <done>bluetooth_audio_state.dart 和 bluetooth_audio_cubit.dart 存在，Cubit 包含完整的權限檢查、版本檢查、Platform Channel 呼叫邏輯</done>
</task>

</tasks>

<verification>
1. flutter pub get 成功
2. flutter analyze 無錯誤
3. 所有檔案已建立並包含所需內容
</verification>

<success_criteria>
- permission_handler 已安裝
- BluetoothAudioModel 可解析原生端返回的 Map
- BluetoothAudioCubit 處理所有狀態轉換（初始、載入中、權限、錯誤、成功）
- 程式碼通過 flutter analyze
</success_criteria>

<output>
完成後建立 `.planning/phases/01-core-display/01-02-SUMMARY.md`
</output>
