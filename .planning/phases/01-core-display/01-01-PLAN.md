---
phase: 01-core-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - android/app/src/main/kotlin/com/tonynowater/mobileosversions/mobile_os_versions/BluetoothAudioHandler.kt
  - android/app/src/main/kotlin/com/tonynowater/mobileosversions/mobile_os_versions/MainActivity.kt
  - android/app/src/main/AndroidManifest.xml
autonomous: true

must_haves:
  truths:
    - "Android 端可以取得已連接的 A2DP 藍牙裝置清單"
    - "Android 端可以取得當前 codec 設定資訊（類型、取樣率、位元深度、聲道模式）"
    - "Platform Channel 方法 getBluetoothAudioInfo 可被呼叫並返回資料"
  artifacts:
    - path: "android/app/src/main/kotlin/com/tonynowater/mobileosversions/mobile_os_versions/BluetoothAudioHandler.kt"
      provides: "藍牙音訊原生處理邏輯"
      min_lines: 150
    - path: "android/app/src/main/AndroidManifest.xml"
      provides: "藍牙權限宣告"
      contains: "BLUETOOTH_CONNECT"
  key_links:
    - from: "BluetoothAudioHandler.kt"
      to: "BluetoothA2dp proxy"
      via: "BluetoothProfile.ServiceListener"
      pattern: "getProfileProxy.*A2DP"
    - from: "MainActivity.kt"
      to: "BluetoothAudioHandler"
      via: "MethodChannel handler registration"
      pattern: "getBluetoothAudioInfo"
---

<objective>
建立 Android 端 Platform Channel Handler，實作藍牙 A2DP 資訊讀取功能

Purpose: 這是整個功能的基礎層，提供原生藍牙 API 存取能力
Output: BluetoothAudioHandler.kt 處理器，可透過 Platform Channel 返回藍牙音訊資訊
</objective>

<execution_context>
@/Users/tonynowater/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tonynowater/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-display/01-RESEARCH.md

# 參考現有 Handler 模式
@android/app/src/main/kotlin/com/tonynowater/mobileosversions/mobile_os_versions/DeviceInfoHandler.kt
@android/app/src/main/kotlin/com/tonynowater/mobileosversions/mobile_os_versions/MainActivity.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 BluetoothAudioHandler.kt</name>
  <files>android/app/src/main/kotlin/com/tonynowater/mobileosversions/mobile_os_versions/BluetoothAudioHandler.kt</files>
  <action>
建立新的 BluetoothAudioHandler 類別，遵循專案現有的 DeviceInfoHandler 模式：

1. 類別結構：
```kotlin
class BluetoothAudioHandler(private val activity: Activity) {
    private var bluetoothA2dp: BluetoothA2dp? = null
    private val bluetoothAdapter: BluetoothAdapter? = BluetoothAdapter.getDefaultAdapter()
    private var pendingResult: MethodChannel.Result? = null
}
```

2. 實作 BluetoothProfile.ServiceListener：
- onServiceConnected: 儲存 BluetoothA2dp proxy，如有 pending request 則處理
- onServiceDisconnected: 清除 proxy

3. 實作 init() 方法：呼叫 bluetoothAdapter.getProfileProxy() 取得 A2DP proxy

4. 實作 release() 方法：呼叫 closeProfileProxy() 釋放資源

5. 實作 handle(call: MethodCall, result: MethodChannel.Result)：
- 當 call.method == "getBluetoothAudioInfo" 時呼叫 getBluetoothAudioInfo(result)
- 其他方法返回 result.notImplemented()

6. 實作 getBluetoothAudioInfo(result: MethodChannel.Result)：
- 檢查 SDK_INT >= 26 (Android 8.0+)，否則返回 {"error": "unsupported", "reason": "Android 8.0 以下不支援"}
- 檢查藍牙是否開啟
- 取得已連接的 A2DP 裝置清單
- 若無裝置，返回 {"error": "no_device"}
- 使用 reflection 存取 getCodecStatus() hidden API（參考 RESEARCH.md 的程式碼範例）
- 返回包含以下欄位的 Map：
  - deviceName: 裝置名稱
  - deviceAddress: MAC 位址
  - codecType: codec 類型（使用常數對照表轉換為字串）
  - sampleRate: 取樣率（轉換為可讀字串如 "48 kHz"）
  - bitsPerSample: 位元深度（轉換為 "16 bit" / "24 bit"）
  - channelMode: 聲道模式（"Mono" / "Stereo"）
  - batteryLevel: 電量（嘗試取得，若失敗返回 -1）

7. 建立 BluetoothCodecConstants object：
- 定義所有 codec 類型、取樣率、位元深度、聲道模式的常數
- 提供 codecTypeToString(), sampleRateToString(), bitsPerSampleToString(), channelModeToString() 轉換方法

注意事項：
- 使用 try-catch 包裝所有 reflection 呼叫，處理 hidden API 存取失敗
- 處理 A2DP proxy 尚未就緒的情況（儲存 pending result，等 ServiceListener 回調後處理）
- 所有欄位都要做 null 安全處理
  </action>
  <verify>
檔案存在且可編譯：
```bash
cd android && ./gradlew compileDebugKotlin 2>&1 | head -50
```
  </verify>
  <done>BluetoothAudioHandler.kt 存在，包含完整的 A2DP proxy 取得邏輯、codec 資訊讀取邏輯（使用 reflection）、常數對照表</done>
</task>

<task type="auto">
  <name>Task 2: 更新 AndroidManifest.xml 藍牙權限</name>
  <files>android/app/src/main/AndroidManifest.xml</files>
  <action>
在 manifest 標籤內新增藍牙權限宣告：

```xml
<!-- Android 11 及以下 -->
<uses-permission android:name="android.permission.BLUETOOTH"
    android:maxSdkVersion="30" />
<uses-permission android:name="android.permission.BLUETOOTH_ADMIN"
    android:maxSdkVersion="30" />

<!-- Android 12+ -->
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
```

這些權限應放在現有的 ACCESS_NETWORK_STATE 和 ACCESS_WIFI_STATE 權限之後。
  </action>
  <verify>
確認權限已加入：
```bash
grep -n "BLUETOOTH" android/app/src/main/AndroidManifest.xml
```
預期輸出包含 BLUETOOTH、BLUETOOTH_ADMIN、BLUETOOTH_CONNECT
  </verify>
  <done>AndroidManifest.xml 包含完整的藍牙權限宣告，涵蓋 Android 11 及以下與 Android 12+ 兩種情況</done>
</task>

<task type="auto">
  <name>Task 3: 整合 BluetoothAudioHandler 到 MainActivity</name>
  <files>android/app/src/main/kotlin/com/tonynowater/mobileosversions/mobile_os_versions/MainActivity.kt</files>
  <action>
修改 MainActivity.kt 以整合 BluetoothAudioHandler：

1. 新增屬性宣告：
```kotlin
private lateinit var bluetoothAudioHandler: BluetoothAudioHandler
```

2. 在 configureFlutterEngine() 中初始化：
```kotlin
bluetoothAudioHandler = BluetoothAudioHandler(this)
bluetoothAudioHandler.init()
```

3. 在 MethodChannel.setMethodCallHandler 的 when 區塊中新增 case：
```kotlin
"getBluetoothAudioInfo" -> {
    bluetoothAudioHandler.handle(call, result)
}
```

4. 覆寫 onDestroy() 釋放資源：
```kotlin
override fun onDestroy() {
    super.onDestroy()
    bluetoothAudioHandler.release()
}
```
  </action>
  <verify>
專案可編譯：
```bash
cd android && ./gradlew compileDebugKotlin 2>&1 | tail -10
```
預期輸出包含 BUILD SUCCESSFUL
  </verify>
  <done>MainActivity.kt 已註冊 BluetoothAudioHandler，Platform Channel 可處理 getBluetoothAudioInfo 呼叫</done>
</task>

</tasks>

<verification>
1. Android 專案可成功編譯
2. BluetoothAudioHandler.kt 存在且包含所需方法
3. AndroidManifest.xml 包含藍牙權限
4. MainActivity.kt 已整合 handler
</verification>

<success_criteria>
- Android 專案編譯成功 (./gradlew compileDebugKotlin)
- BluetoothAudioHandler 實作完整的 A2DP 資訊讀取邏輯
- Platform Channel 方法 "getBluetoothAudioInfo" 已註冊
- 藍牙權限已正確宣告
</success_criteria>

<output>
完成後建立 `.planning/phases/01-core-display/01-01-SUMMARY.md`
</output>
